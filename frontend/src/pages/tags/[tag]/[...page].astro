---
import Layout from '~/layouts/Layout.astro'
import Pagination from '~/components/Pagination.astro'
import siteConfig from '~/site.config'
import PostPreview from '~/components/PostPreview.astro'
import PageHeader from '~/components/PageHeader.astro'
import DataState from '~/components/DataState.astro'
import ErrorState from '~/components/ErrorState.astro'
import EmptyState from '~/components/EmptyState.astro'
import { getPublicTagBySlug, listPublicArticles } from '~/lib/publicApi'
import { DEFAULT_PAGE_SIZE, normalizePageSize } from '~/lib/config'

export const prerender = false

const tagSlug = String(Astro.params.tag ?? '').trim()
if (!tagSlug) throw new Response('Not Found', { status: 404 })

const pageParam = String(Astro.params.page ?? '').trim()
const segments = pageParam ? pageParam.split('/').filter(Boolean) : []
const currentPage = segments.length === 0 ? 1 : Number.parseInt(segments[0]!, 10)
if (!Number.isFinite(currentPage) || currentPage < 1 || segments.length > 1) {
  throw new Response('Not Found', { status: 404 })
}

let tag
let result: Awaited<ReturnType<typeof listPublicArticles>> | null = null
let tagError: string | null = null
let listError: string | null = null
const pageSize = normalizePageSize(siteConfig.tagPageSize, DEFAULT_PAGE_SIZE)

try {
  tag = await getPublicTagBySlug(tagSlug)
} catch (err) {
  const status = err instanceof Error && err.message === 'HTTP_404' ? 404 : 502
  if (status === 404) throw new Response('Not Found', { status: 404 })
  tagError = err instanceof Error ? err.message : 'Failed to load tag from server API'
}

if (tag) {
  try {
    result = await listPublicArticles({ page: currentPage, pageSize, tag: tagSlug })
    const totalPages = Math.max(1, Math.ceil(result.total / pageSize))
    if (currentPage > totalPages) throw new Response('Not Found', { status: 404 })
  } catch (err) {
    if (err instanceof Response) throw err
    listError = err instanceof Error ? err.message : 'Failed to load posts from server API'
  }
}

const tagTitle = tag ? tag.name : tagSlug
const pageTitle = `Tag: ${tagTitle}` + (currentPage > 1 ? ` - Page ${currentPage}` : '')
const totalPages = result ? Math.max(1, Math.ceil(result.total / pageSize)) : 1
const prevLink =
  currentPage > 2
    ? `/tags/${encodeURIComponent(tagSlug)}/${currentPage - 1}`
    : currentPage === 2
      ? `/tags/${encodeURIComponent(tagSlug)}`
      : undefined
const nextLink = result && currentPage < totalPages ? `/tags/${encodeURIComponent(tagSlug)}/${currentPage + 1}` : undefined
---

<Layout title={pageTitle} description={`All posts tagged with ${tagTitle}`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['tags', tagTitle]} />
    {
      tagError ? (
        <DataState title="Failed to load tag" description="Please check your connection and try again.">
          <ErrorState message={tagError} retryHref={Astro.url.pathname} retryText="Try again" secondaryHref="/tags" secondaryText="Browse tags" />
        </DataState>
      ) : listError ? (
        <DataState title="Failed to load posts" description="Please check your connection and try again.">
          <ErrorState
            message={listError}
            retryHref={Astro.url.pathname}
            retryText="Try again"
            secondaryHref={`/tags/${encodeURIComponent(tagSlug)}`}
            secondaryText="Back to tag"
          />
        </DataState>
      ) : result && result.items.length === 0 ? (
        <DataState title="No posts found" description={`No posts are tagged with "${tagTitle}".`}>
          <EmptyState title="No results" message="Try another tag or browse the archive." actionHref="/posts" actionText="Go to archive" />
        </DataState>
      ) : result ? (
        <>
          {result.items.map((article) => <PostPreview article={article} />)}
          <Pagination prevLink={prevLink} prevText="Newer Posts" nextLink={nextLink} nextText="Older Posts" />
        </>
      ) : null
    }
  </div>
</Layout>
