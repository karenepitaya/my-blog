---
import Layout from '~/layouts/Layout.astro'
import PostPreview from '~/components/PostPreview.astro'
import Pagination from '~/components/Pagination.astro'
import BlockHeader from '~/components/BlockHeader.astro'
import HomeBanner from '~/components/HomeBanner.astro'
import siteConfig from '~/site.config'
import TagsSection from '~/components/TagsSection.astro'
import CategoriesSection from '~/components/CategoriesSection.astro'
import DataState from '~/components/DataState.astro'
import ErrorState from '~/components/ErrorState.astro'
import EmptyState from '~/components/EmptyState.astro'
import { listPublicArticles, listPublicCategories, listPublicTags } from '~/lib/publicApi'
import { DEFAULT_PAGE_SIZE, normalizePageSize } from '~/lib/config'

export const prerender = false

const homePageSize = normalizePageSize(siteConfig.homePageSize, DEFAULT_PAGE_SIZE)

const emptyPaged = (pageSize: number) => ({ items: [], total: 0, page: 1, pageSize })

let homeError: string | null = null
let articles = emptyPaged(homePageSize)
let categories = emptyPaged(200)
let tags = emptyPaged(200)

try {
  const [a, c, t] = await Promise.all([
    listPublicArticles({ page: 1, pageSize: homePageSize }),
    listPublicCategories({ page: 1, pageSize: 200 }),
    listPublicTags({ page: 1, pageSize: 200 }),
  ])
  articles = a
  categories = c
  tags = t
} catch (err) {
  homeError = err instanceof Error ? err.message : 'Failed to load data from server API'
}

const isAllEmpty = articles.items.length === 0 && categories.items.length === 0 && tags.items.length === 0
---

<Layout>
  <HomeBanner />
  {
    homeError && (
      <section class="mt-6 md:mx-2">
        <DataState title="Failed to load homepage data" description="Please check your connection and try again.">
          <ErrorState
            message={
              typeof homeError === 'string' && homeError.trim()
                ? `Error: ${homeError}`
                : 'Failed to load data from the server.'
            }
            retryHref={Astro.url.pathname}
            retryText="Try again"
            secondaryHref="/posts"
            secondaryText="Browse posts"
          />
        </DataState>
      </section>
    )
  }
  {
    isAllEmpty &&
      !homeError && (
        <section class="mt-6 md:mx-2">
          <DataState title="No content found" description="There are no posts, categories, or tags to show yet.">
            <EmptyState
              title="Nothing to show"
              message="Try browsing the archive or come back later."
              actionHref="/posts"
              actionText="Go to archive"
            />
          </DataState>
        </section>
      )
  }
  {
    articles.items.length > 0 && (
      <section>
        <BlockHeader>Latest Posts</BlockHeader>
        {articles.items.map((article) => (
          <PostPreview article={article} />
        ))}
        <Pagination nextLink="/posts" nextText="Archive" />
      </section>
    )
  }
  {
    categories.items.length > 0 && (
      <section>
        <BlockHeader>Categories</BlockHeader>
        <CategoriesSection categories={categories.items} />
      </section>
    )
  }
  {
    tags.items.length > 0 && (
      <section>
        <BlockHeader>Tags</BlockHeader>
        <TagsSection tags={tags.items} />
      </section>
    )
  }
</Layout>

<style is:global>
  a.heading-anchor {
    display: none !important;
  }
</style>
