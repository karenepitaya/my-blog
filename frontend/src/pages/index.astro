---
import Layout from '~/layouts/Layout.astro'
import { getCollection, render } from 'astro:content'
import PostPreview from '~/components/PostPreview.astro'
import Pagination from '~/components/Pagination.astro'
import BlockHeader from '~/components/BlockHeader.astro'
import HomeBanner from '~/components/HomeBanner.astro'
import siteConfig from '~/site.config'
import TagsSection from '~/components/TagsSection.astro'
import CategoriesSection from '~/components/CategoriesSection.astro'
import { listPublicArticles, listPublicCategories, listPublicTags } from '~/lib/publicApi'

export const prerender = false

const home = await getCollection('home')
let HomeContent
let homeAvatarImage
let homeGithubCalendar
if (home.length > 0) {
  const homeEntry = home[0]
  const { Content } = await render(homeEntry)
  HomeContent = Content
  homeAvatarImage = homeEntry.data.avatarImage
  homeGithubCalendar = homeEntry.data.githubCalendar
}

const [articles, categories, tags] = await Promise.all([
  listPublicArticles({ page: 1, pageSize: Math.floor(siteConfig.pageSize / 2) }),
  listPublicCategories({ page: 1, pageSize: 200 }),
  listPublicTags({ page: 1, pageSize: 200 }),
])
---

<Layout>
  {
    HomeContent && (
      <HomeBanner avatarImage={homeAvatarImage} githubCalendar={homeGithubCalendar}>
        <HomeContent />
      </HomeBanner>
    )
  }
  {
    articles.items.length > 0 && (
      <section>
        <BlockHeader>Latest Posts</BlockHeader>
        {articles.items.map((article) => (
          <PostPreview article={article} />
        ))}
        <Pagination nextLink="/posts" nextText="Archive" />
      </section>
    )
  }
  {
    categories.items.length > 0 && (
      <section>
        <BlockHeader>Categories</BlockHeader>
        <CategoriesSection categories={categories.items} />
      </section>
    )
  }
  {
    tags.items.length > 0 && (
      <section>
        <BlockHeader>Tags</BlockHeader>
        <TagsSection tags={tags.items} />
      </section>
    )
  }
</Layout>

<style is:global>
  a.heading-anchor {
    display: none !important;
  }
</style>
