---
import Layout from '~/layouts/Layout.astro'
import PageHeader from '~/components/PageHeader.astro'
import Pagination from '~/components/Pagination.astro'
import AuthorCardLarge from '~/components/author-cards/AuthorCardLarge.astro'
import PostPreview from '~/components/PostPreview.astro'
import DataState from '~/components/DataState.astro'
import ErrorState from '~/components/ErrorState.astro'
import EmptyState from '~/components/EmptyState.astro'
import siteConfig from '~/site.config'
import { getPublicAuthorByUsername, listPublicArticles, type PublicAuthor } from '~/lib/publicApi'
import { DEFAULT_PAGE_SIZE, normalizePageSize } from '~/lib/config'

export const prerender = false

const author = String(Astro.params.author ?? '').trim()
if (!author) throw new Response('Not Found', { status: 404 })

const resolveErrorStatus = (err: unknown): number => {
  if (err instanceof Error && err.message.startsWith('HTTP_')) {
    const numeric = Number.parseInt(err.message.replace('HTTP_', ''), 10)
    if (Number.isFinite(numeric)) return numeric
  }
  if (typeof err === 'object' && err !== null && 'status' in err) {
    const status = (err as { status?: number }).status
    if (typeof status === 'number') return status
  }
  return 502
}

const pageParam = String(Astro.url.searchParams.get('page') ?? '1').trim()
const currentPage = Number.parseInt(pageParam || '1', 10)
if (!Number.isFinite(currentPage) || currentPage < 1) {
  throw new Response('Not Found', { status: 404 })
}

let authorData: PublicAuthor | null = null
let authorError: string | null = null

try {
  authorData = await getPublicAuthorByUsername(author)
} catch (err) {
  const status = resolveErrorStatus(err)
  if (status === 404) throw new Response('Not Found', { status: 404 })
  authorError = err instanceof Error ? err.message : 'Failed to load author from server API'
}

const pageSize = normalizePageSize(siteConfig.archivePageSize, DEFAULT_PAGE_SIZE)
let posts: Awaited<ReturnType<typeof listPublicArticles>> | null = null
let postsError: string | null = null

if (authorData) {
  try {
    posts = await listPublicArticles({ page: currentPage, pageSize, authorId: authorData.id, sort: 'publishedAt' })
    const totalPages = Math.max(1, Math.ceil(posts.total / pageSize))
    if (currentPage > totalPages) throw new Response('Not Found', { status: 404 })
  } catch (err) {
    if (err instanceof Response) throw err
    postsError = err instanceof Error ? err.message : 'Failed to load author posts from server API'
  }
}

const basePath = `/authors/${encodeURIComponent(author)}`
const totalPages = posts ? Math.max(1, Math.ceil(posts.total / pageSize)) : 1
const prevLink =
  currentPage > 2 ? `${basePath}?page=${currentPage - 1}` : currentPage === 2 ? basePath : undefined
const nextLink = posts && currentPage < totalPages ? `${basePath}?page=${currentPage + 1}` : undefined
---

<Layout title={`Author: ${author}`} description={`Author profile: ${author}`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['authors', author]} />

    <section class="mt-6 md:mx-2">
      {
        authorError ? (
          <DataState title="Failed to load author" description="Please check your connection and try again.">
            <ErrorState
              message={authorError}
              retryHref={Astro.url.pathname}
              retryText="Try again"
              secondaryHref="/about"
              secondaryText="Back to About"
            />
          </DataState>
        ) : authorData ? (
          <div class="flex flex-col gap-6">
            <AuthorCardLarge author={authorData} />

            <div>
              <h2 class="text-heading2 text-xl font-semibold mb-4">Posts</h2>
              {
                postsError ? (
                  <DataState variant="inline">
                    <ErrorState message={postsError} retryHref={basePath} retryText="Try again" secondaryHref="/posts" secondaryText="Browse posts" />
                  </DataState>
                ) : posts && posts.items.length === 0 ? (
                  <DataState variant="inline">
                    <EmptyState title="No posts" message="This author has not published any posts yet." actionHref="/posts" actionText="Browse posts" />
                  </DataState>
                ) : posts ? (
                  <>
                    {posts.items.map((article) => <PostPreview article={article} />)}
                    <Pagination prevLink={prevLink} prevText="Newer Posts" nextLink={nextLink} nextText="Older Posts" />
                  </>
                ) : null
              }
            </div>
          </div>
        ) : null
      }
    </section>
  </div>
</Layout>
