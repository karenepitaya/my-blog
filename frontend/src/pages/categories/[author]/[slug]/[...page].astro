---
import Layout from '~/layouts/Layout.astro'
import PageHeader from '~/components/PageHeader.astro'
import PostPreview from '~/components/PostPreview.astro'
import Pagination from '~/components/Pagination.astro'
import siteConfig from '~/site.config'
import {
  getPublicCategoryByAuthorSlug,
  getPublicCategoryByOwnerIdSlug,
  listPublicArticles,
} from '~/lib/publicApi'
import { DEFAULT_PAGE_SIZE, normalizePageSize } from '~/lib/config'

export const prerender = false

const author = String(Astro.params.author ?? '').trim()
const slug = String(Astro.params.slug ?? '').trim()
if (!author || !slug) throw new Response('Not Found', { status: 404 })

const pageParam = String(Astro.params.page ?? '').trim()
const segments = pageParam ? pageParam.split('/').filter(Boolean) : []
const currentPage = segments.length === 0 ? 1 : Number.parseInt(segments[0]!, 10)
if (!Number.isFinite(currentPage) || currentPage < 1 || segments.length > 1) {
  throw new Response('Not Found', { status: 404 })
}

const isObjectId = /^[0-9a-fA-F]{24}$/.test(author)
let category
try {
  category = isObjectId
    ? await getPublicCategoryByOwnerIdSlug({ authorId: author, slug })
    : await getPublicCategoryByAuthorSlug({ authorUsername: author, slug })
} catch (err) {
  const status = err instanceof Error && err.message === 'HTTP_404' ? 404 : 502
  throw new Response('Not Found', { status })
}

const pageSize = normalizePageSize(siteConfig.categoryPageSize, DEFAULT_PAGE_SIZE)
const result = await listPublicArticles({ page: currentPage, pageSize, categoryId: category.id })
const totalPages = Math.max(1, Math.ceil(result.total / pageSize))
if (currentPage > totalPages) {
  throw new Response('Not Found', { status: 404 })
}

const basePath = `/categories/${encodeURIComponent(author)}/${encodeURIComponent(slug)}`
const pageTitle = `Category: ${category.name}` + (currentPage > 1 ? ` - Page ${currentPage}` : '')
const prevLink =
  currentPage > 2 ? `${basePath}/${currentPage - 1}` : currentPage === 2 ? basePath : undefined
const nextLink = currentPage < totalPages ? `${basePath}/${currentPage + 1}` : undefined
---

<Layout title={pageTitle} description={`All posts in the ${category.name} category`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['categories', category.name]} />
    {result.items.map((article) => <PostPreview article={article} />)}
    <Pagination prevLink={prevLink} prevText="Newer Posts" nextLink={nextLink} nextText="Older Posts" />
  </div>
</Layout>
