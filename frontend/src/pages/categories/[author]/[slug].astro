---
import Layout from '~/layouts/Layout.astro'
import PageHeader from '~/components/PageHeader.astro'
import PostPreview from '~/components/PostPreview.astro'
import Pagination from '~/components/Pagination.astro'
import siteConfig from '~/site.config'
import DataState from '~/components/DataState.astro'
import ErrorState from '~/components/ErrorState.astro'
import EmptyState from '~/components/EmptyState.astro'
import {
  getPublicCategoryByAuthorSlug,
  getPublicCategoryByOwnerIdSlug,
  listPublicArticles,
} from '~/lib/publicApi'
import { DEFAULT_PAGE_SIZE, normalizePageSize } from '~/lib/config'

export const prerender = false

const author = String(Astro.params.author ?? '').trim()
const slug = String(Astro.params.slug ?? '').trim()
if (!author || !slug) throw new Response('Not Found', { status: 404 })

const isObjectId = /^[0-9a-fA-F]{24}$/.test(author)
let category
try {
  category = isObjectId
    ? await getPublicCategoryByOwnerIdSlug({ authorId: author, slug })
    : await getPublicCategoryByAuthorSlug({ authorUsername: author, slug })
} catch (err) {
  const status = err instanceof Error && err.message === 'HTTP_404' ? 404 : 502
  throw new Response('Not Found', { status })
}

const pageSize = normalizePageSize(siteConfig.categoryPageSize, DEFAULT_PAGE_SIZE)
const basePath = `/categories/${encodeURIComponent(author)}/${encodeURIComponent(slug)}`

let articles: Awaited<ReturnType<typeof listPublicArticles>> | null = null
let totalPages = 1
let listError: string | null = null
try {
  articles = await listPublicArticles({ page: 1, pageSize, categoryId: category.id })
  totalPages = Math.max(1, Math.ceil(articles.total / pageSize))
} catch (err) {
  articles = null
  listError = err instanceof Error ? err.message : 'Failed to load posts from server API'
}

const nextLink = totalPages > 1 ? `${basePath}/2` : undefined
---

<Layout title={`Category: ${category.name}`} description={`All posts in the ${category.name} category`}>
  <div class="mt-2 sm:mt-0">
    <PageHeader titlePieces={['categories', category.name]} />
    {
      listError ? (
        <DataState title="Failed to load posts" description="Please check your connection and try again.">
          <ErrorState
            message={listError}
            retryHref={Astro.url.pathname}
            retryText="Try again"
            secondaryHref="/categories"
            secondaryText="Browse categories"
          />
        </DataState>
      ) : articles && articles.items.length === 0 ? (
        <DataState title="No posts found" description={`No posts are in "${category.name}".`}>
          <EmptyState title="No posts" message="Try browsing the archive or another category." actionHref="/posts" actionText="Go to archive" />
        </DataState>
      ) : articles ? (
        <>
          {articles.items.map((article) => <PostPreview article={article} />)}
          {nextLink && <Pagination nextLink={nextLink} nextText="Older Posts" />}
        </>
      ) : null
    }
  </div>
</Layout>
