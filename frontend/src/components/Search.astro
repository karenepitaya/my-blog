---
import IconCircleX from '~/icons/circle-x.svg'
import IconSearch from '~/icons/search.svg'
import DataState from '~/components/DataState.astro'
import LoadingState from '~/components/LoadingState.astro'
import EmptyState from '~/components/EmptyState.astro'
import ErrorState from '~/components/ErrorState.astro'

const { trailingSlashes = false } = Astro.props
---

<site-search class="ms-auto" id="search" data-trailing-slashes={trailingSlashes}>
  <button
    type="button"
    class="hover:text-accent flex cursor-pointer items-center justify-center rounded-md p-1 hover:bg-foreground/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/30"
    aria-keyshortcuts="Control+K Meta+K"
    data-open-modal
    disabled
  >
    <IconSearch class="size-6 text-accent" aria-hidden="true" />
    <span class="sr-only">Open Search</span>
  </button>

  <dialog
    aria-label="search"
    class="text-foreground! bg-background max-h-5/6 min-h-48 w-7/8 sm:w-5/6 max-w-xl border-double! border-4 border-accent/30 shadow-sm backdrop:backdrop-blur-sm open:flex mx-auto mt-10 sm:mt-16 mb-auto rounded-xl"
  >
    <div class="dialog-frame flex grow flex-col gap-4 p-6 pt-6 max-w-full">
      <button
        type="button"
        class="cursor-pointer fixed top-2 right-2 rounded-full p-1 hover:bg-foreground/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/30"
        data-close-modal
        aria-label="Close search"
      >
        <IconCircleX class="size-6 text-accent/50" aria-hidden="true" />
      </button>

      <div class="search-container">
        <label class="sr-only" for="site-search-input">Search</label>
        <input
          id="site-search-input"
          data-search-input
          type="search"
          autocomplete="off"
          aria-controls="site-search-results"
          aria-autocomplete="list"
          placeholder="Search posts..."
          class="w-full rounded-xl border border-foreground/10 bg-foreground/5 px-4 py-3 text-sm outline-none focus:border-accent/40"
        />

        <div class="mt-3 hidden flex-wrap items-center gap-2 text-xs text-foreground/70" data-search-recent>
          <span class="text-foreground/60">Recent:</span>
          <div class="flex flex-wrap gap-2" data-search-recent-items></div>
          <button
            type="button"
            class="ml-auto underline text-foreground/60 hover:text-foreground"
            data-search-clear-recent
          >
            Clear
          </button>
        </div>

        <div class="mt-4" data-search-state>
          <div class="hidden" data-search-loading>
            <DataState variant="inline">
              <LoadingState label="Searching..." />
            </DataState>
          </div>

          <div class="hidden" data-search-error>
            <DataState variant="inline">
              <ErrorState title="Search failed" message="Please try again.">
                <div slot="actions">
                  <button
                    type="button"
                    class="inline-flex text-accent border-3 border-accent/30 border-double py-1.5 px-3 whitespace-nowrap hover:bg-accent/8 rounded-xl transition-colors"
                    data-search-retry
                  >
                    Retry
                  </button>
                </div>
              </ErrorState>
            </DataState>
          </div>

          <div class="hidden" data-search-empty>
            <DataState variant="inline">
              <EmptyState
                title="No results"
                message="Try a different keyword or browse the archive."
                actionHref="/posts"
                actionText="Go to archive"
              />
            </DataState>
          </div>
        </div>

        <ul
          id="site-search-results"
          class="mt-4 space-y-2"
          data-search-results
          role="listbox"
          aria-label="Search results"
        ></ul>
      </div>
    </div>
  </dialog>
</site-search>

<style>
  mark {
    background-color: var(--theme-accent);
    color: var(--theme-background);
    font-weight: 600;
    padding: 0 3px;
    border-radius: 6px;
  }

  [data-result-option][aria-selected='true'] > a {
    border-color: color-mix(in srgb, var(--theme-accent), transparent 60%);
    outline: 1px solid color-mix(in srgb, var(--theme-accent), transparent 60%);
    outline-offset: 2px;
  }

  .recent-chip {
    border: 1px solid color-mix(in srgb, var(--theme-foreground), transparent 90%);
    background: color-mix(in srgb, var(--theme-foreground), transparent 94%);
    border-radius: 9999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    color: color-mix(in srgb, var(--theme-foreground), transparent 30%);
    transition: color 120ms ease, border-color 120ms ease, background-color 120ms ease;
  }
  .recent-chip:hover {
    color: var(--theme-heading1);
    border-color: color-mix(in srgb, var(--theme-accent), transparent 60%);
  }
</style>

<script>
  function resolveApiBase() {
    const raw = import.meta.env.PUBLIC_API_BASE_URL
    const base = raw?.trim() ? raw.trim().replace(/\/$/, '') : 'http://localhost:3000/api'
    return base
  }

  function buildQuery(params: Record<string, unknown>) {
    const search = new URLSearchParams()
    for (const [key, value] of Object.entries(params)) {
      if (value === undefined || value === null) continue
      search.set(key, String(value))
    }
    const qs = search.toString()
    return qs ? `?${qs}` : ''
  }

  type SearchItem = {
    id?: string
    slug?: string
    title?: string
    author?: { username?: string }
  }

  class SiteSearch extends HTMLElement {
    #closeBtn: HTMLButtonElement | null
    #dialog: HTMLDialogElement | null
    #dialogFrame: HTMLDivElement | null
    #openBtn: HTMLButtonElement | null
    #input: HTMLInputElement | null
    #results: HTMLUListElement | null
    #errorBox: HTMLDivElement | null
    #retryBtn: HTMLButtonElement | null
    #loadingBox: HTMLDivElement | null
    #emptyBox: HTMLDivElement | null
    #recentBox: HTMLDivElement | null
    #recentItems: HTMLDivElement | null
    #clearRecentBtn: HTMLButtonElement | null
    #controller: AbortController
    #searchAbort: AbortController | null
    #lastQuery: string
    #requestSeq: number
    #activeIndex: number
    #lastActive: HTMLElement | null
    trailingSlashes: boolean
    stripTrailingSlash: (path: string) => string
    formatURL: (path: string) => string

    constructor() {
      super()
      this.#openBtn = this.querySelector<HTMLButtonElement>('button[data-open-modal]')
      this.#closeBtn = this.querySelector<HTMLButtonElement>('button[data-close-modal]')
      this.#dialog = this.querySelector<HTMLDialogElement>('dialog')
      this.#dialogFrame = this.querySelector('.dialog-frame')
      this.#input = this.querySelector<HTMLInputElement>('input[data-search-input]')
      this.#results = this.querySelector<HTMLUListElement>('ul[data-search-results]')
      this.#errorBox = this.querySelector<HTMLDivElement>('[data-search-error]')
      this.#loadingBox = this.querySelector<HTMLDivElement>('[data-search-loading]')
      this.#emptyBox = this.querySelector<HTMLDivElement>('[data-search-empty]')
      this.#recentBox = this.querySelector<HTMLDivElement>('[data-search-recent]')
      this.#recentItems = this.querySelector<HTMLDivElement>('[data-search-recent-items]')
      this.#clearRecentBtn = this.querySelector<HTMLButtonElement>('[data-search-clear-recent]')
      this.#retryBtn = this.querySelector<HTMLButtonElement>('[data-search-retry]')
      this.#controller = new AbortController()
      this.#searchAbort = null
      this.#lastQuery = ''
      this.#requestSeq = 0
      this.#activeIndex = -1
      this.#lastActive = null

      this.trailingSlashes = this.dataset.trailingSlashes === 'true' ? true : false
      this.stripTrailingSlash = (path: string) => path.replace(/(.)\/(#.*)?$/, '$1$2')
      this.formatURL = !this.trailingSlashes ? this.stripTrailingSlash : (path: string) => path

      if (this.#openBtn) {
        this.#openBtn.addEventListener('click', this.openModal)
        this.#openBtn.disabled = false
      }

      if (this.#closeBtn) {
        this.#closeBtn.addEventListener('click', this.closeModal)
      }

      if (this.#dialog) {
        this.#dialog.addEventListener('close', () => {
          window.removeEventListener('click', this.onWindowClick)
          document.body.classList.remove('overflow-hidden')
          const target = this.#lastActive ?? this.#openBtn
          target?.focus?.()
        })
      }

      if (this.#input) {
        this.#input.addEventListener('input', this.onInput, { signal: this.#controller.signal })
        this.#input.addEventListener('keydown', this.onInputKeydown, { signal: this.#controller.signal })
      }

      if (this.#retryBtn) {
        this.#retryBtn.addEventListener('click', () => this.runSearch(this.#lastQuery), {
          signal: this.#controller.signal,
        })
      }

      if (this.#clearRecentBtn) {
        this.#clearRecentBtn.addEventListener(
          'click',
          () => {
            this.clearRecent()
            this.renderRecent()
          },
          { signal: this.#controller.signal }
        )
      }

      this.renderRecent()
    }

    connectedCallback() {
      window.addEventListener('keydown', this.onWindowKeydown, { signal: this.#controller.signal })
    }

    disconnectedCallback() {
      this.#controller.abort()
      this.#searchAbort?.abort()
    }

    openModal = (event?: MouseEvent) => {
      if (!this.#dialog) return
      this.#lastActive = document.activeElement as HTMLElement | null

      document.body.classList.add('overflow-hidden')
      this.#dialog.showModal()
      this.#input?.focus()

      event?.stopPropagation()
      window.addEventListener('click', this.onWindowClick, { signal: this.#controller.signal })
    }

    closeModal = () => {
      this.#dialog?.close()
    }

    onWindowClick = (event: MouseEvent) => {
      const isLink = 'href' in (event.target || {})
      if (
        isLink ||
        (document.body.contains(event.target as Node) && !this.#dialogFrame?.contains(event.target as Node))
      ) {
        this.closeModal()
      }
    }

    onWindowKeydown = (e: KeyboardEvent) => {
      if (!this.#dialog) return
      if ((e.metaKey === true || e.ctrlKey === true) && e.key === 'k') {
        this.#dialog.open ? this.closeModal() : this.openModal()
        e.preventDefault()
      }
    }

    showLoading = (show: boolean) => {
      this.#loadingBox?.classList.toggle('hidden', !show)
    }

    showError = (show: boolean) => {
      this.#errorBox?.classList.toggle('hidden', !show)
    }

    showEmpty = (show: boolean) => {
      this.#emptyBox?.classList.toggle('hidden', !show)
    }

    clearResults = () => {
      if (this.#results) this.#results.innerHTML = ''
      this.setActiveIndex(-1)
    }

    escapeHtml = (input: unknown) => {
      const s = String(input ?? '')
      return s
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
    }

    highlight = (text: string, query: string) => {
      const rawQ = String(query ?? '').trim()
      if (!rawQ) return this.escapeHtml(text)

      const safeText = this.escapeHtml(text)
      const safeQ = this.escapeHtml(rawQ)
      const idx = safeText.toLowerCase().indexOf(safeQ.toLowerCase())
      if (idx < 0) return safeText
      const before = safeText.slice(0, idx)
      const match = safeText.slice(idx, idx + safeQ.length)
      const after = safeText.slice(idx + safeQ.length)
      return `${before}<mark>${match}</mark>${after}`
    }

    setActiveIndex = (index: number) => {
      this.#activeIndex = index
      if (!this.#results || !this.#input) return

      const options = Array.from(this.#results.querySelectorAll<HTMLElement>('[data-result-option]'))
      options.forEach((el, i) => {
        el.setAttribute('aria-selected', i === index ? 'true' : 'false')
      })

      const activeEl = index >= 0 ? options[index] : null
      if (activeEl?.id) {
        this.#input.setAttribute('aria-activedescendant', activeEl.id)
        activeEl.scrollIntoView({ block: 'nearest' })
      } else {
        this.#input.removeAttribute('aria-activedescendant')
      }
    }

    renderResults = (items: SearchItem[]) => {
      if (!this.#results) return
      this.#results.innerHTML = ''
      this.setActiveIndex(-1)

      for (let i = 0; i < items.length; i++) {
        const article = items[i]
        const authorUsername = article?.author?.username ? String(article.author.username) : ''
        const slug = String(article?.slug ?? '')
        const title = String(article?.title ?? '')
        const id = String(article?.id ?? '')

        const articlePath = authorUsername
          ? `/posts/${encodeURIComponent(authorUsername)}/${encodeURIComponent(slug)}`
          : `/posts`
        const linkBase = this.formatURL(articlePath)
        const href = id ? `${linkBase}?id=${encodeURIComponent(id)}` : linkBase

        const li = document.createElement('li')
        li.id = `site-search-option-${i}`
        li.dataset.resultOption = '1'
        li.setAttribute('role', 'option')
        li.setAttribute('aria-selected', 'false')
        li.innerHTML = `
          <a
            class="block rounded-xl border border-foreground/10 bg-foreground/5 px-4 py-3 hover:border-accent/40 transition-colors"
            href="${href}"
          >
            <div class="text-sm font-semibold text-heading1 truncate">${this.highlight(title || '(untitled)', this.#lastQuery)}</div>
            ${
              authorUsername
                ? `<div class="mt-1 text-xs text-foreground/70 truncate">@${this.escapeHtml(authorUsername)}</div>`
                : `<div class="mt-1 text-xs text-foreground/60 truncate">Author unavailable</div>`
            }
          </a>
        `.trim()
        li.addEventListener(
          'mouseenter',
          () => this.setActiveIndex(i),
          { signal: this.#controller.signal }
        )
        this.#results.appendChild(li)
      }
    }

    onInput = (e: Event) => {
      const raw = (e.target as HTMLInputElement | null)?.value ?? ''
      const q = String(raw).trim()
      this.runSearch(q)
    }

    onInputKeydown = (e: KeyboardEvent) => {
      if (!this.#results) return
      const options = Array.from(this.#results.querySelectorAll<HTMLElement>('[data-result-option]'))

      if (e.key === 'ArrowDown') {
        if (options.length === 0) return
        e.preventDefault()
        const next = Math.min(options.length - 1, this.#activeIndex + 1)
        this.setActiveIndex(next < 0 ? 0 : next)
        return
      }

      if (e.key === 'ArrowUp') {
        if (options.length === 0) return
        e.preventDefault()
        const next = Math.max(0, this.#activeIndex - 1)
        this.setActiveIndex(next)
        return
      }

      if (e.key === 'Enter') {
        if (this.#activeIndex < 0) return
        const option = options[this.#activeIndex]
        const link = option?.querySelector('a[href]') as HTMLAnchorElement | null
        const href = link?.getAttribute('href')
        if (!href) return
        e.preventDefault()
        window.location.href = href
        this.closeModal()
        return
      }

      if (e.key === 'Escape') {
        this.closeModal()
      }
    }

    loadRecent = (): string[] => {
      try {
        const raw = localStorage.getItem('recent-searches')
        const parsed = raw ? JSON.parse(raw) : []
        return Array.isArray(parsed) ? parsed.map((s) => String(s)).filter(Boolean).slice(0, 5) : []
      } catch {
        return []
      }
    }

    saveRecent = (items: string[]) => {
      try {
        localStorage.setItem('recent-searches', JSON.stringify(items.slice(0, 5)))
      } catch {
        // ignore
      }
    }

    addRecent = (query: string) => {
      const q = String(query ?? '').trim()
      if (!q) return
      const list = this.loadRecent().filter((x) => x.toLowerCase() !== q.toLowerCase())
      list.unshift(q)
      this.saveRecent(list)
      this.renderRecent()
    }

    clearRecent = () => {
      try {
        localStorage.removeItem('recent-searches')
      } catch {
        // ignore
      }
    }

    renderRecent = () => {
      if (!this.#recentBox || !this.#recentItems) return
      const list = this.loadRecent()
      this.#recentItems.innerHTML = ''

      if (list.length === 0) {
        this.#recentBox.classList.add('hidden')
        return
      }

      this.#recentBox.classList.remove('hidden')
      for (const q of list) {
        const btn = document.createElement('button')
        btn.type = 'button'
        btn.className = 'recent-chip'
        btn.textContent = q
        btn.addEventListener(
          'click',
          () => {
            if (!this.#input) return
            this.#input.value = q
            this.runSearch(q)
            this.#input.focus()
          },
          { signal: this.#controller.signal }
        )
        this.#recentItems.appendChild(btn)
      }
    }

    runSearch = async (q: string) => {
      this.#lastQuery = String(q ?? '').trim()
      const query = this.#lastQuery

      this.showError(false)
      this.showEmpty(false)

      if (!query) {
        this.#searchAbort?.abort()
        this.clearResults()
        this.showLoading(false)
        this.showError(false)
        this.showEmpty(false)
        return
      }

      this.#searchAbort?.abort()
      this.#searchAbort = new AbortController()
      const signal = this.#searchAbort.signal
      const requestId = ++this.#requestSeq

      this.showLoading(true)
      this.showError(false)
      this.showEmpty(false)

      try {
        const apiBase = resolveApiBase()
        const url = `${apiBase}/public/articles${buildQuery({
          q: query,
          page: 1,
          pageSize: 10,
          sort: 'publishedAt',
        })}`

        const res = await fetch(url, { headers: { Accept: 'application/json' }, signal })
        if (!res.ok) throw new Error(`HTTP_${res.status}`)
        const json = await res.json()
        if (!json?.success) throw new Error('API_ERROR')

        if (requestId !== this.#requestSeq) return

        const items = Array.isArray(json?.data?.items) ? json.data.items : []
        this.renderResults(items)
        this.showLoading(false)
        this.showEmpty(items.length === 0)
        this.addRecent(query)
      } catch (err: unknown) {
        if (signal.aborted) return
        if (import.meta.env.DEV) console.error('Search failed:', err)
        this.clearResults()
        this.showLoading(false)
        this.showError(true)
      }
    }
  }

  customElements.define('site-search', SiteSearch)
</script>
