---
import IconCircleX from '~/icons/circle-x.svg'
import IconSearch from '~/icons/search.svg'
import DataState from '~/components/DataState.astro'
import LoadingState from '~/components/LoadingState.astro'
import EmptyState from '~/components/EmptyState.astro'
import ErrorState from '~/components/ErrorState.astro'

const { trailingSlashes = false } = Astro.props
---

<site-search class="ms-auto" id="search" data-trailing-slashes={trailingSlashes}>
  <button
    class="hover:text-accent flex cursor-pointer items-center justify-center rounded-md"
    aria-keyshortcuts="Control+K Meta+K"
    data-open-modal
    disabled
  >
    <IconSearch class="size-6 text-accent" />
    <span class="sr-only">Open Search</span>
  </button>
  <dialog
    aria-label="search"
    class="text-foreground! bg-background max-h-5/6 min-h-48 w-7/8 sm:w-5/6 max-w-xl border-double! border-4 border-accent/30 shadow-sm backdrop:backdrop-blur-sm open:flex mx-auto mt-10 sm:mt-16 mb-auto rounded-xl"
  >
    <div class="dialog-frame flex grow flex-col gap-4 p-6 pt-6 max-w-full">
      <button class="cursor-pointer fixed top-2 right-2 rounded-full" data-close-modal aria-label="Close search">
        <IconCircleX class="size-6 text-accent/50" />
      </button>
      <div class="search-container">
        <label class="sr-only" for="site-search-input">Search</label>
        <input
          id="site-search-input"
          data-search-input
          type="search"
          autocomplete="off"
          placeholder="Search posts…"
          class="w-full rounded-xl border border-foreground/10 bg-foreground/5 px-4 py-3 text-sm outline-none focus:border-accent/40"
        />

        <div class="mt-4" data-search-state>
          <div class="hidden" data-search-loading>
            <DataState variant="inline">
              <LoadingState label="Searching…" />
            </DataState>
          </div>

          <div class="hidden" data-search-error>
            <DataState variant="inline">
              <ErrorState title="Search failed" message="Please try again.">
                <div slot="actions">
                  <button
                    type="button"
                    class="inline-flex text-accent border-3 border-accent/30 border-double py-1.5 px-3 whitespace-nowrap hover:bg-accent/8 rounded-xl transition-colors"
                    data-search-retry
                  >
                    Retry
                  </button>
                </div>
              </ErrorState>
            </DataState>
          </div>

          <div class="hidden" data-search-empty>
            <DataState variant="inline">
              <EmptyState title="No results" message="Try a different keyword or browse the archive." actionHref="/posts" actionText="Go to archive" />
            </DataState>
          </div>
        </div>

        <ul class="mt-4 space-y-2" data-search-results aria-label="Search results"></ul>
      </div>
    </div>
  </dialog>
</site-search>

<script>
  function resolveApiBase() {
    const raw = import.meta.env.PUBLIC_API_BASE_URL
    const base = raw?.trim() ? raw.trim().replace(/\/$/, '') : 'http://localhost:3000/api'
    return base
  }

  function buildQuery(params) {
    const search = new URLSearchParams()
    for (const [key, value] of Object.entries(params)) {
      if (value === undefined || value === null) continue
      search.set(key, String(value))
    }
    const qs = search.toString()
    return qs ? `?${qs}` : ''
  }

  class SiteSearch extends HTMLElement {
    #closeBtn: HTMLButtonElement | null
    #dialog: HTMLDialogElement | null
    #dialogFrame: HTMLDivElement | null
    #openBtn: HTMLButtonElement | null
    #input: HTMLInputElement | null
    #results: HTMLUListElement | null
    #errorBox: HTMLDivElement | null
    #retryBtn: HTMLButtonElement | null
    #loadingBox: HTMLDivElement | null
    #emptyBox: HTMLDivElement | null
    #controller: AbortController
    #searchAbort: AbortController | null
    #lastQuery: string
    #requestSeq: number
    trailingSlashes: boolean
    stripTrailingSlash: (path: string) => string
    formatURL: (path: string) => string

    constructor() {
      super()
      this.#openBtn = this.querySelector<HTMLButtonElement>('button[data-open-modal]')
      this.#closeBtn = this.querySelector<HTMLButtonElement>('button[data-close-modal]')
      this.#dialog = this.querySelector<HTMLDialogElement>('dialog')
      this.#dialogFrame = this.querySelector('.dialog-frame')
      this.#input = this.querySelector<HTMLInputElement>('input[data-search-input]')
      this.#results = this.querySelector<HTMLUListElement>('ul[data-search-results]')
      this.#errorBox = this.querySelector<HTMLDivElement>('[data-search-error]')
      this.#loadingBox = this.querySelector<HTMLDivElement>('[data-search-loading]')
      this.#emptyBox = this.querySelector<HTMLDivElement>('[data-search-empty]')
      this.#retryBtn = this.querySelector<HTMLButtonElement>('[data-search-retry]')
      this.#controller = new AbortController()
      this.#searchAbort = null
      this.#lastQuery = ''
      this.#requestSeq = 0

      this.trailingSlashes = this.dataset.trailingSlashes === 'true' ? true : false
      this.stripTrailingSlash = (path: string) => path.replace(/(.)\/(#.*)?$/, '$1$2')
      this.formatURL = !this.trailingSlashes
        ? this.stripTrailingSlash
        : (path: string) => path

      // Set up events
      if (this.#openBtn) {
        this.#openBtn.addEventListener('click', this.openModal)
        this.#openBtn.disabled = false
      } else {
        console.warn('Search button not found')
      }

      if (this.#closeBtn) {
        this.#closeBtn.addEventListener('click', this.closeModal)
      } else {
        console.warn('Close button not found')
      }

      if (this.#dialog) {
        this.#dialog.addEventListener('close', () => {
          window.removeEventListener('click', this.onWindowClick)
          const body = document.querySelector('body')
          body?.classList.remove('overflow-hidden')
        })
      } else {
        console.warn('Dialog not found')
      }

      if (this.#input) {
        this.#input.addEventListener('input', this.onInput, { signal: this.#controller.signal })
      } else {
        console.warn('Search input not found')
      }

      if (this.#retryBtn) {
        this.#retryBtn.addEventListener('click', () => this.runSearch(this.#lastQuery), {
          signal: this.#controller.signal,
        })
      }
    }

    connectedCallback() {
      // window events, requires cleanup
      window.addEventListener('keydown', this.onWindowKeydown, {
        signal: this.#controller.signal,
      })
    }

    disconnectedCallback() {
      this.#controller.abort()
      this.#searchAbort?.abort()
    }

    openModal = (event?: MouseEvent) => {
      if (!this.#dialog) {
        console.warn('Dialog not found')
        return
      }

      const body = document.querySelector('body')
      body?.classList.add('overflow-hidden')

      this.#dialog.showModal()
      this.querySelector('input')?.focus()
      event?.stopPropagation()
      window.addEventListener('click', this.onWindowClick, {
        signal: this.#controller.signal,
      })
    }

    closeModal = () => {
      this.#dialog?.close()
    }

    onWindowClick = (event: MouseEvent) => {
      // check if it's a link
      const isLink = 'href' in (event.target || {})
      // make sure the click is either a link or outside of the dialog
      if (
        isLink ||
        (document.body.contains(event.target as Node) &&
          !this.#dialogFrame?.contains(event.target as Node))
      ) {
        this.closeModal()
      }
    }

    onWindowKeydown = (e: KeyboardEvent) => {
      if (!this.#dialog) {
        console.warn('Dialog not found')
        return
      }
      // check if it's the Control+K or ⌘+K shortcut
      if ((e.metaKey === true || e.ctrlKey === true) && e.key === 'k') {
        this.#dialog.open ? this.closeModal() : this.openModal()
        e.preventDefault()
      }
    }

    showLoading = (show: boolean) => {
      if (!this.#loadingBox) return
      this.#loadingBox.classList.toggle('hidden', !show)
    }

    showError = (show: boolean) => {
      if (!this.#errorBox) return
      this.#errorBox.classList.toggle('hidden', !show)
    }

    showEmpty = (show: boolean) => {
      if (!this.#emptyBox) return
      this.#emptyBox.classList.toggle('hidden', !show)
    }

    clearResults = () => {
      if (this.#results) this.#results.innerHTML = ''
    }

    renderResults = (items) => {
      if (!this.#results) return
      this.#results.innerHTML = ''

      for (const article of items) {
        const authorUsername = article?.author?.username ? String(article.author.username) : ''
        const slug = String(article?.slug ?? '')
        const title = String(article?.title ?? '')
        const id = String(article?.id ?? '')

        const articlePath = authorUsername
          ? `/posts/${encodeURIComponent(authorUsername)}/${encodeURIComponent(slug)}`
          : `/posts`
        const linkBase = this.formatURL(articlePath)
        const href = id ? `${linkBase}?id=${encodeURIComponent(id)}` : linkBase

        const li = document.createElement('li')
        li.innerHTML = `
          <a
            class="block rounded-xl border border-foreground/10 bg-foreground/5 px-4 py-3 hover:border-accent/40 transition-colors"
            href="${href}"
          >
            <div class="text-sm font-semibold text-heading1 truncate">${title || '(untitled)'}</div>
            ${
              authorUsername
                ? `<div class="mt-1 text-xs text-foreground/70 truncate">@${authorUsername}</div>`
                : `<div class="mt-1 text-xs text-foreground/60 truncate">Author unavailable</div>`
            }
          </a>
        `.trim()
        this.#results.appendChild(li)
      }
    }

    onInput = (e: Event) => {
      const raw = (e.target as HTMLInputElement | null)?.value ?? ''
      const q = String(raw).trim()
      this.runSearch(q)
    }

    runSearch = async (q: string) => {
      this.#lastQuery = String(q ?? '').trim()
      const query = this.#lastQuery
      this.showError(false)
      this.showEmpty(false)

      if (!query) {
        this.#searchAbort?.abort()
        this.clearResults()
        this.showLoading(false)
        this.showError(false)
        this.showEmpty(false)
        return
      }

      this.#searchAbort?.abort()
      this.#searchAbort = new AbortController()
      const signal = this.#searchAbort.signal
      const requestId = ++this.#requestSeq
      this.showLoading(true)
      this.showError(false)
      this.showEmpty(false)

      try {
        const apiBase = resolveApiBase()
        const url = `${apiBase}/public/articles${buildQuery({
          q: query,
          page: 1,
          pageSize: 10,
          sort: 'publishedAt',
        })}`

        const res = await fetch(url, { headers: { Accept: 'application/json' }, signal })
        if (!res.ok) throw new Error(`HTTP_${res.status}`)
        const json = await res.json()
        if (!json?.success) throw new Error('API_ERROR')

        if (requestId !== this.#requestSeq) return

        const items = Array.isArray(json?.data?.items) ? json.data.items : []
        this.renderResults(items)
        this.showLoading(false)
        this.showEmpty(items.length === 0)
      } catch (err: any) {
        if (signal.aborted) return
        console.error('Search failed:', err)
        this.clearResults()
        this.showLoading(false)
        this.showError(true)
      }
    }
  }

  customElements.define('site-search', SiteSearch)
</script>
